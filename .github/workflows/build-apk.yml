name: Build Android APK (TWA)

on:
  workflow_dispatch:
    inputs:
      manifest_url:
        description: 'Cloudflare Tunnel Manifest URL (e.g. https://xyz.trycloudflare.com/manifest.webmanifest)'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Verify and Fix Manifest URL
        id: fix_url
        run: |
          URL="${{ github.event.inputs.manifest_url }}"
          # Remove trailing slash if present
          URL="${URL%/}"
          # If URL doesn't end with .webmanifest or .json, append /manifest.webmanifest
          if [[ ! "$URL" =~ \.(webmanifest|json)$ ]]; then
            URL="$URL/manifest.webmanifest"
          fi
          echo "Corrected Manifest URL: $URL"
          echo "url=$URL" >> $GITHUB_OUTPUT
          
          # Check reachability with a browser-like User-Agent to avoid 403 Forbidden
          curl -f -I -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" "$URL" || (echo "ERROR: Manifest URL is not reachable from GitHub. Ensure your Cloudflare Tunnel is running and that you can open $URL in your computer's browser." && exit 1)

      - name: Install Bubblewrap
        run: sudo npm install -g @bubblewrap/cli

      - name: Configure Bubblewrap
        run: |
          mkdir -p ~/.bubblewrap
          echo "{\"jdkPath\":\"$JAVA_HOME\",\"androidSdkPath\":\"$ANDROID_SDK_ROOT\"}" > ~/.bubblewrap/config.json
          cat ~/.bubblewrap/config.json

      - name: Initialize TWA Project
        run: |
          mkdir android-app
          cd android-app
          # Use corrected URL from the fix_url step
          yes "" | bubblewrap init --manifest="${{ steps.fix_url.outputs.url }}" --confirmResNames

      - name: Build APK
        run: |
          cd android-app
          # We need to provide dummy answers for signing key generation
          printf "password\npassword\nJohn Doe\nIT\nKrishiSahAI\nBaramati\nMaharashtra\nIN\nyes\n" | bubblewrap build
          
      - name: Find APK
        run: |
          echo "APK_PATH=$(find android-app -name "*signed.apk" | head -n 1)" >> $GITHUB_ENV

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: KrishiSahAI-Android-APK
          path: ${{ env.APK_PATH }}
